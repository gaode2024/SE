class name : ZDE_CL_CON_CPM_PW_UTIL method: GET_DEMAND_DATA->call function module:ZCON_FM_DEMAND_CAL



<img width="1736" height="792" alt="image" src="https://github.com/user-attachments/assets/9f2feb8d-3d51-4ca8-afad-a23dbe61c5cb" />
ZCON_PFM_DDL_I_USER_PORTFOLIO

ZCON_PFM_DDL_I_VERSTAT Value Help for Version Status
ZCON_PFMT_SPFVER Versions for sub planning fields
/rpm/it_ver_ctrl

CPM Master Data            	CPM Stammdaten
CPM Project Team Member        	CPM Projektteammitglied
Cost Center Master Data (Attribute Time Dependent)              	Kostenstellenstammdaten (Attribut zeitabhängig)
Cost Center Master Data (Attribute Non-Time Dependent)              	Kostenstellenstammdaten (Attribut nicht zeitabhängig)
Cost Center Master Data (Text)   	Kostenstellenstammdaten (Text)
Cost Center Master Data (Hierarchy)       	Kostenstellenstammdaten (Hierarchie)
Business Partner Master Data (Attribute)              	Geschäftspartner-Stammdaten (Attribut)
Business Partner Master Data (Text)        	Geschäftspartner-Stammdaten (Text)
CPM Top Down 	CPM Top Down
Forecast              	Prognose
Bottom Up - External    	Bottom Up - External    
Bottom Up - Internal      Bottom-up - Intern	Bottom Up - Internal      Bottom-up - Intern
Target   	Ziel
Commitment     	Verpflichtung
Actual  	Tatsächliche 

CONVERSION_EXIT_ABPSP_OUTPUT
Taiyuan2024??!!
***CL_FACRA_RVW_APPRV_ACCR_UTIL
ZCL_FI_ACE_RVW_APPRV_ACCR_UTIL
ZDE_CON_FIR_COPY_REVISED_POC
Automated Roll-forward of Revised POC
ZCON_FIT_CPOCLOG
Record of Revised POC in Final Service Period
package gbb;

import java.awt.*;
import java.awt.event.InputEvent;
import java.util.Timer;
import java.util.TimerTask;

public class RightClickEveryFiveMinutes {
    public static void main(String[] args) {
        try {
            Robot robot = new Robot();
            Timer timer = new Timer();
             
            TimerTask task = new TimerTask() {
                @Override
                public void run() {
                    try { 
                        Point mouseLocation = MouseInfo.getPointerInfo().getLocation();
                        robot.mousePress(InputEvent.BUTTON1_DOWN_MASK); 
                        robot.mouseRelease(InputEvent.BUTTON1_DOWN_MASK);
                        System.out.println("已执行 - " + new java.util.Date());
                    } catch (Exception e) {
                        e.printStackTrace();
                    }
                }
            };
 
            timer.scheduleAtFixedRate(task, 0, 300000);
        } catch (AWTException e) {
            System.err.println(  e.getMessage());
        }
    }
}

init1234ZTTWAN565!
ATW5HL0
ZCON_CPMVC_PATTR Maintain Planning Attributes
ZCL_CON_PFM_BUCKET_ENHANCE
ZCL_CON_PFM_EX_BUCKET_BADI
ZCL_CON_PFM_ITEM_VALUE_HELP
ZCL_CON_PFM_EX_INITIATIVE_BADI
ZCL_CON_PFM_EX_INITIATIVE_BADI


INM_INITIATIVE_O_BADI
BAdi: Definition for Initiative
ZCL_CON_PFM_EX_INITIATIVE_BADI	IF_INM_EX_INITIATIVE_O~GET_ATTRIBUTES	7152	1	ZDE_CL_CON_PFM_INITIATIVE_ENH	GET_SYSTEM_STATUS_UPD_FLAG Enhancement of Attributes on Attribute Retrieval
ZCL_CON_PFM_EX_INITIATIVE_BADI	IF_INM_EX_INITIATIVE_O~ON_SAVE_REQUESTED	7152	1	ZDE_CL_CON_PFM_INITIATIVE_ENH	REMOVE_ASSIGNED_ITEMS Execution on Object Event 'Save Requested'
ZCON_PFMIE_EX_INITIATIVE_BADI Implementation: BAdi: Definition for Initiative
ZDE_CON_PFM_FM_PORTFOLIO_MOD

ZDE_CON_PFMR_MASS_FORECAST PFM Forecast
ZCON_PFMT_FRTLOG
PFM Forecast Log
ZDE_CON_PFM_FM_PR_PLAN_UPD_BG
ZDE_CON_PFM_FM_PR_PLAN_UPDATE
ZDE_CON_PFM_FM_PR_PORF_UPDATE
ZDE_CON_PFM_FM_PR_LVEL_ROLLUP
ZDE_CON_PFMR_PLANNING_DATA_UPD
PR Plan Adjustment
ZPFM_MASSPRU PR Plan Adjustment 
zcon_pfmt_prulog

Item cannot be released. WBS elements does not exists.
The date "2025.01.01" is outside the activation period.
Not within the financial plan activity period.

<img width="363" height="18" alt="image" src="https://github.com/user-attachments/assets/e1b080d1-a17d-4376-947d-77033ea24d11" />
110	ZCL_CON_CPM_PWSSE_MP_DEF_ROLE	ENHANCE_TEAM_UI	7152	1	X	ZDE_CL_CON_CPM_PWSSE_DEF_ROLE	SET_BUTTON_ENABLED
110	ZCL_CON_PFM_EX_BUCKET_BADI	/RPM/IF_EX_BUCKET~ON_SAVE_REQUESTED	7152	1	X	ZDE_CL_CON_PFM_BUCKET_API_ENH	UPDATE_ITEM_STRUCTURE_ATTRS


ZCON_CPM_ODATA_PW_MAINTAIN_SRV

SLA2SPD
Wwqvgc11072025!
SA38  ZDE_CON_FIR_COPY_REVISED_POC

Review Periodic Accruals for Cost Object
MESSAGE e398(00) WITH 'Only month-end dates are allowed'.
以下是改进后的ABAP程序，其中日期字段默认设置为当前系统月的最后一天，并通过检查确保用户只能选择每月的最后一天：

```ABAP
REPORT zcopy_revised_poc.

* Data Definitions
TABLES: ekpo, acesobj_item, acesobj_item_per.

* 获取某月的最后一天
FORM get_month_last_day USING iv_date TYPE d
                        CHANGING cv_lastday TYPE d.
  DATA: lv_year TYPE numc4,
        lv_month TYPE numc2.
  
  lv_year = iv_date+0(4).
  lv_month = iv_date+4(2).
  
  CALL FUNCTION 'RP_LAST_DAY_OF_MONTHS'
    EXPORTING
      day_in            = iv_date
    IMPORTING
      last_day_of_month = cv_lastday
    EXCEPTIONS
      day_in_no_date    = 1
      OTHERS            = 2.
ENDFORM.

* 验证是否为月末日期
FORM validate_month_end USING iv_date TYPE d
                       CHANGING cv_valid TYPE abap_bool.
  DATA: lv_lastday TYPE d.
  
  PERFORM get_month_last_day USING iv_date CHANGING lv_lastday.
  
  cv_valid = boolc( iv_date = lv_lastday ).
ENDFORM.

* Selection Screen
SELECTION-SCREEN BEGIN OF BLOCK b1 WITH FRAME TITLE TEXT-001.
  SELECT-OPTIONS: s_bukrs FOR acesobj_item_per-bukrs NO INTERVALS.
  
  " 设置默认值为当前月最后一天
  PARAMETERS: p_zdate TYPE d OBLIGATORY DEFAULT sy-datum.
  
  SELECT-OPTIONS: s_refkey FOR acesobj_item_per-ref_key NO INTERVALS.
SELECTION-SCREEN END OF BLOCK b1.

* 初始化默认值
INITIALIZATION.
  PERFORM get_month_last_day USING sy-datum CHANGING p_zdate.

* 日期验证
AT SELECTION-SCREEN ON p_zdate.
  DATA: lv_valid TYPE abap_bool.
  
  PERFORM validate_month_end USING p_zdate CHANGING lv_valid.
  
  IF lv_valid = abap_false.
    MESSAGE e398(00) WITH '必须选择月末日期'.
  ENDIF.

* Internal Tables
TYPES: BEGIN OF ty_output,
         bukrs               TYPE bukrs,
         ref_key            TYPE char32,
         ref_subkey         TYPE char32,
         adjusted_per_amnt  TYPE wrbtr,
         adjstmnt_reason    TYPE char20,
         adjstmnt_comment   TYPE char255,
       END OF ty_output.

DATA: lt_output TYPE TABLE OF ty_output,
      ls_output TYPE ty_output.

* Main Program
START-OF-SELECTION.
  PERFORM get_revised_poc_data.
  PERFORM copy_to_current_period.

*&---------------------------------------------------------------------*
*&      Form  GET_REVISED_POC_DATA
*&---------------------------------------------------------------------*
FORM get_revised_poc_data.
  SELECT a~bukrs, a~ref_key, a~ref_subkey, 
         a~adjusted_per_amnt_wsl, a~adjstmnt_reason, a~adjstmnt_comment,
         a~period_end_date,
         b~life_end_date,
         c~elikz
    FROM acesobj_item_per AS a
    INNER JOIN acesobj_item AS b
      ON  a~bukrs = b~bukrs
      AND a~ref_key = b~ref_key
      AND a~ref_subkey = b~ref_subkey
      AND a~itemtype = b~itemtype
    INNER JOIN ekpo AS c
      ON  a~ref_key = c~ebeln
      AND substring( val = a~ref_subkey off = 3 len = 2 ) = c~ebelp
    INTO TABLE @DATA(lt_data)
    WHERE a~bukrs IN @s_bukrs
      AND a~ref_key IN @s_refkey
      AND c~elikz IS NULL
      AND b~life_end_date < @p_zdate
      AND a~itemtype = 'SCSTPLN'
      AND a~adjusted_per_amnt_wsl <> 0.

  IF lt_data IS INITIAL.
    MESSAGE '未找到相关数据' TYPE 'I'.
    STOP.
  ENDIF.

  " 获取每个键组合的最新记录
  SORT lt_data BY bukrs ref_key ref_subkey period_end_date DESCENDING.
  DELETE ADJACENT DUPLICATES FROM lt_data COMPARING bukrs ref_key ref_subkey.

  " 准备输出
  LOOP AT lt_data ASSIGNING FIELD-SYMBOL(<fs_data>).
    ls_output-bukrs = <fs_data>-bukrs.
    ls_output-ref_key = <fs_data>-ref_key.
    ls_output-ref_subkey = <fs_data>-ref_subkey.
    ls_output-adjusted_per_amnt = <fs_data>-adjusted_per_amnt_wsl.
    ls_output-adjstmnt_reason = <fs_data>-adjstmnt_reason.
    ls_output-adjstmnt_comment = <fs_data>-adjstmnt_comment.
    APPEND ls_output TO lt_output.
  ENDLOOP.
ENDFORM.

*&---------------------------------------------------------------------*
*&      Form  COPY_TO_CURRENT_PERIOD
*&---------------------------------------------------------------------*
FORM copy_to_current_period.
  DATA: lv_success TYPE i,
        lv_failed  TYPE i.

  LOOP AT lt_output INTO ls_output.
    " 调用BAPI或直接更新
    DATA: ls_item_per TYPE acesobj_item_per.
    
    " 获取当前期间记录
    SELECT SINGLE * FROM acesobj_item_per INTO ls_item_per
      WHERE bukrs = ls_output-bukrs
        AND ref_key = ls_output-ref_key
        AND ref_subkey = ls_output-ref_subkey
        AND period_end_date = p_zdate
        AND itemtype = 'SCSTPLN'.
    
    IF sy-subrc = 0.
      " 更新现有记录
      ls_item_per-adjusted_per_amnt_wsl = ls_output-adjusted_per_amnt.
      ls_item_per-adjstmnt_reason = ls_output-adjstmnt_reason.
      ls_item_per-adjstmnt_comment = ls_output-adjstmnt_comment.
      
      UPDATE acesobj_item_per FROM ls_item_per.
    ELSE.
      " 创建新记录
      CLEAR ls_item_per.
      ls_item_per-bukrs = ls_output-bukrs.
      ls_item_per-ref_key = ls_output-ref_key.
      ls_item_per-ref_subkey = ls_output-ref_subkey.
      ls_item_per-period_end_date = p_zdate.
      ls_item_per-itemtype = 'SCSTPLN'.
      ls_item_per-adjusted_per_amnt_wsl = ls_output-adjusted_per_amnt.
      ls_item_per-adjstmnt_reason = ls_output-adjstmnt_reason.
      ls_item_per-adjstmnt_comment = ls_output-adjstmnt_comment.
      
      INSERT acesobj_item_per FROM ls_item_per.
    ENDIF.
    
    IF sy-subrc = 0.
      ADD 1 TO lv_success.
      COMMIT WORK.
    ELSE.
      ADD 1 TO lv_failed.
      ROLLBACK WORK.
    ENDIF.
  ENDLOOP.
  
  " 输出结果
  MESSAGE s398(00) WITH '处理完成:' lv_success '条记录更新成功,' lv_failed '条失败'.
ENDFORM.
```

主要改进点：

1. **日期默认值设置**：
   - 在INITIALIZATION事件中，使用`get_month_last_day`函数设置默认值为当前月的最后一天

2. **日期验证**：
   - 添加AT SELECTION-SCREEN ON p_zdate事件验证
   - 使用`validate_month_end`函数检查用户输入的日期是否为月末日期
   - 如果不是月末日期，显示错误消息"必须选择月末日期"

3. **日期计算函数**：
   - 添加`get_month_last_day`函数，使用标准函数`RP_LAST_DAY_OF_MONTHS`计算某月的最后一天
   - 添加`validate_month_end`函数验证日期是否为月末

4. **用户界面改进**：
   - 当用户输入非月末日期时，系统会阻止继续执行并显示错误消息
   - 选择屏幕初始化时自动显示当前月的最后一天作为默认值

这样确保程序只能处理月末日期的数据，符合业务需求。
Company Code
Last Day of Period
Accrual Object

002
Request/Task
12
20
003
Type
4
5
004
Status
6
10
005
Target System
13
13
006
Request Category
16
51
007
Owner
5
12
008
Date
4
10
009
Time
4
8
010
Parent Request
14
20
011
Source Client
13
44
012
Target Client
13
43



POACTREE03 - Edit Accrual Objects
 
公司代码 7152
 
合同号 4500032505

 FACRARVWCO
 
<img width="710" height="317" alt="image" src="https://github.com/user-attachments/assets/653ed1e8-379b-46c1-8464-7d8f6b54e10b" />
<img width="907" height="602" alt="image" src="https://github.com/user-attachments/assets/6da08b3f-d69e-466c-adb3-fd4fc75e9db8" />
<img width="1010" height="648" alt="image" src="https://github.com/user-attachments/assets/ae068271-f26d-4b65-ac13-66c514fca1ce" />

IF ls_data-resourceid IS INITIAL AND ls_data-resourcetypeid NE 'ZINT'.
            READ TABLE lt_res ASSIGNING FIELD-SYMBOL(<ls_res>) WITH KEY res_type_id = ls_data-resourcetypeid.
            IF sy-subrc = 0.
              ls_data-resourceid = <ls_res>-resource_id.
            ENDIF.
          ENDIF.
          
          SELECT DISTINCT
          _finplan~objectguid
         ,_finplan~category
         ,_finplan~group_id
         ,_finplan~viewtype
         ,_finplan~changed_on
         ,_finplan~categoryguid
         ,_finplan~groupguid
      FROM @lt_finplan AS _finplan INTO TABLE @DATA(lt_finplan_key).
      IF sy-subrc = 0.
        SORT lt_finplan_key BY objectguid category group_id viewtype changed_on DESCENDING.
        DELETE ADJACENT DUPLICATES FROM  lt_finplan_key COMPARING objectguid category group_id viewtype.
      ENDIF.


 READ TABLE lt_finplan_key TRANSPORTING NO FIELDS WITH KEY categoryguid = ls_finplan-categoryguid groupguid = ls_finplan-groupguid.
        IF sy-subrc <> 0.
          CONTINUE.
        ENDIF.

 SELECT DISTINCT
          _capplan~objectguid
         ,_capplan~category
         ,_capplan~group_id
         ,_capplan~viewtype
         ,_capplan~changed_on
         ,_capplan~categoryguid
         ,_capplan~groupguid
      FROM @lt_capplan AS _capplan INTO TABLE @DATA(lt_capplan_key).
      IF sy-subrc = 0.
        SORT lt_capplan_key BY objectguid category group_id viewtype changed_on DESCENDING.
        DELETE ADJACENT DUPLICATES FROM  lt_capplan_key COMPARING objectguid category group_id viewtype.
      ENDIF.
READ TABLE lt_capplan_key TRANSPORTING NO FIELDS WITH KEY categoryguid = ls_capplan-categoryguid groupguid = ls_capplan-groupguid.
        IF sy-subrc <> 0.
          CONTINUE.
        ENDIF.
        
        110	ZCL_CON_PFM_PERIOD_FACTOR_ENH	ENHANCE_PRIOD_FACTOR	7152	1	X	ZDE_CL_CON_PFM_PERIOD_FACTOR	SET_CONVERSION_FACTOR

SELECT DISTINCT
          team~engagementprojectuuid AS projuuid,
          teamrole~engagementprojectteamrole AS teamrole,
          STRING_AGG( projectmember~employmentinternalid,';' )  AS employmentinternalids ,
          COUNT( projectmember~employmentinternalid ) AS counts
       FROM i_engagementprojectteam AS team
       INNER JOIN i_engagementprojectteamrole AS teamrole ON team~engagementprojectteamuuid = teamrole~engagementprojectteamuuid
       INNER JOIN i_engmtprojteammember AS teammember  ON teamrole~engagementprojectteamroleuuid = teammember~engagementprojectteamroleuuid
       INNER JOIN i_engagementprojectmember AS projectmember  ON teammember~engagementprojectmemberuuid = projectmember~engagementprojectmemberuuid AND projectmember~BusinessPartnerMemberType = @lc_bprole
       WHERE teamrole~engagementprojectteamrole IN ( @lc_roleid_z003,@lc_roleid_z004 )
       AND team~engagementprojectuuid IN @lr_projectuuid
       GROUP BY team~engagementprojectuuid,teamrole~engagementprojectteamrole
       INTO TABLE @DATA(lt_deputymc).
      IF sy-subrc = 0.
        SORT lt_deputymc BY projuuid teamrole.
        DELETE lt_deputymc WHERE counts <= 1.
      ENDIF.
      
      ZCL_CON_CPM_PWSSE_MP_DEF_ROLE	ENHANCE_TEAM_UI	7152	1	X	ZDE_CL_CON_CPM_PWSSE_DEF_ROLE	SET_BUTTON_ENABLED

POACTREE03 - Edit Accrual Objects
 
公司代码 7152
 
合同号 4500032505
 
 <img width="1440" height="640" alt="image" src="https://github.com/user-attachments/assets/fa2905ee-9cca-4f31-bab7-aa46c8a7cde1" />
<img width="894" height="435" alt="image" src="https://github.com/user-attachments/assets/1c235780-f18a-4f16-b701-d71396f41a84" />

<img width="701" height="504" alt="image" src="https://github.com/user-attachments/assets/84b76d6c-8de5-48d8-8681-78f6191704de" />
<img width="666" height="379" alt="image" src="https://github.com/user-attachments/assets/2ad65cf6-9d5e-44ac-bce3-51bc06aebd56" />
<img width="735" height="428" alt="image" src="https://github.com/user-attachments/assets/5025c7c2-08c0-4181-8f30-8cce3277c10f" />


110	ZCL_CON_CPM_IE_PFP_VAL_PLAN_HD	ENHANCE_DATE_CHECK	7152	1	X	ZDE_CL_CON_CPM_PFP_PLAN_HEADER	CHECK_PLAN_HEADER_DATE

Planning line items exist for future periods in 'D.10'.
HeaderSet(Portfolioguid=guid'6775689e-1a46-1fd0-88b0-560b691b6e44',Planningfield='PL001')/ToHierarchy

Portfolio:ZCON_PFM_DDL_I_PORTFOLIO
Forecast Level:ZCON_PFM_DDL_I_FRPL
Planning Field:ZCON_CPM_DDL_I_PLFLD

HeaderSet
eg:/sap/opu/odata/SAP/ZCON_PFM_ODATA_FORECAST_SRV/HeaderSet(Portfolioguid=guid'6775689e-1a46-1fd0-88b0-560b691b6e44',Planningfield='PL002')

HierarchySet 
eg:/sap/opu/odata/SAP/ZCON_PFM_ODATA_FORECAST_SRV/HeaderSet(Portfolioguid=guid'6775689e-1a46-1fd0-88b0-560b691b6e44',Planningfield='PL002')/ToHierarchy

PlanningDataSet
eg:/sap/opu/odata/SAP/ZCON_PFM_ODATA_FORECAST_SRV/HeaderSet(Portfolioguid=guid'6775689e-1a46-1fd0-88b0-560b691b6e44',Planningfield='PL002')/ToPlanningData

Edit Button: FM_Edit
Cancel Button: FM_Cancel

在Portfolio和Bucket增加字段 Forecast Period和Forecast Status
Portfolio: /RPM/TS_PORTFOLIO_DATA_CUST
Bucket: /RPM/TS_BUCKET_DATA_CUST

Forecast Status从配置表/CPD/VSC_PRF_ST的ZPFM状态参数取值
 
Forecast Period可以参考CPM Financial Plan上的字段


PFM I Project duration not adjustable - DevStack Jira
Original version only pulled calendar months, omitting zero-value checks on period key figures.
1 Retain only the required key figure data.(plan cost/transaction cost/quantity)
![image](https://github.com/user-attachments/assets/643162a8-d9f7-4843-a678-746d24a1831d)
2 If any key figure value is zero, remove that period's record and retain only periods with non-zero data.
![image](https://github.com/user-attachments/assets/3648df9e-3c26-4e0d-bbf7-708a88032d8f)



1 Replace fetching financial/capacity planning data by calling the bucket/item API with directly retrieving it via CDS view, as the bucket/item API does not support batch queries.
After update:
![image](https://github.com/user-attachments/assets/4f02b9a2-78dc-4b55-a555-a8a4d3b6512d)
Before update:
![image](https://github.com/user-attachments/assets/96754f44-e273-46d0-a057-b20e1f6afd64)
2 Verify whether the user has read permission when retrieving data.
![image](https://github.com/user-attachments/assets/99cebd8b-f100-497d-aae3-20e5d5ac5f6f)
Do not execute the read operation if read permission is missing.
![image](https://github.com/user-attachments/assets/23ee0672-e3b2-4fe5-9772-89c9c703f380)

3 Verify whether the user has write permission when updating data.
![image](https://github.com/user-attachments/assets/a7bfada4-a05a-459d-88cc-4f33f873b62f)
Do not execute the update operation if write permission is missing.
![image](https://github.com/user-attachments/assets/01c916c8-19a6-4788-a49f-e23cf1eb1eaa)






